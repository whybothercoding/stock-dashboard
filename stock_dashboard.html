<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndieGoWeb Daily Stock Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind production warning
        window.tailwind = { config: { theme: { extend: {} } } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for sort indicators */
        .sortable::after {
            content: "↕";
            position: absolute;
            right: 10px;
            opacity: 0.5;
            font-size: 0.8em;
        }

        .sort-asc::after {
            content: "↑";
            opacity: 1;
        }

        .sort-desc::after {
            content: "↓";
            opacity: 1;
        }

        /* Tailwind UI inspired theme */
        .theme-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .theme-surface {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .theme-text-primary {
            color: #1f2937;
        }
        
        .theme-text-secondary {
            color: #6b7280;
        }
        
        .theme-border {
            border-color: #e5e7eb;
        }
        
        .theme-shadow {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .theme-button-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transition: all 0.2s ease;
        }
        
        .theme-button-primary:hover {
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
            transform: translateY(-1px);
        }
        
        .theme-button-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .theme-button-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
        }
        
        .theme-button-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        .theme-button-danger:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
        }
        
        /* Table styling for expanded columns */
        #stock-table {
            min-width: 1400px;
        }
        
        #stock-table th,
        #stock-table td {
            white-space: nowrap;
            min-width: 80px;
        }
        
        #stock-table th:first-child,
        #stock-table td:first-child {
            min-width: 100px;
        }
        
        #stock-table th:nth-child(4),
        #stock-table td:nth-child(4) {
            min-width: 90px;
        }
        
        #stock-table th:nth-child(9),
        #stock-table td:nth-child(9) {
            min-width: 100px;
        }
        
        #stock-table th:nth-child(10),
        #stock-table td:nth-child(10) {
            min-width: 120px;
        }
    </style>
</head>
<body class="theme-card min-h-screen p-5">
    <div class="max-w-7xl mx-auto theme-surface rounded-2xl theme-shadow overflow-hidden">
        <div class="bg-gradient-to-r from-slate-800 to-slate-700 text-white p-8 text-center">
            <h1 class="text-4xl font-bold mb-3">IndieGoWeb Daily Stock Dashboard</h1>
            <p class="text-gray-200 text-lg">Real-time stock monitoring and market sentiment analysis</p>
        </div>

        <div class="p-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold theme-text-primary mb-6">Watchlist Overview</h2>
                
                <div id="loading" class="text-center py-10">
                    <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
                    <p class="text-gray-600">Fetching latest data...</p>
                </div>

                <div id="watchlist-content" class="hidden">
                    <div class="bg-white rounded-lg theme-shadow overflow-hidden mb-6">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200" id="stock-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable relative" data-column="ticker">Ticker</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable relative" data-column="price">Price</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable relative" data-column="change">Change %</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable relative" data-column="changeAmount">Change $</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable relative" data-column="open">Open</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable relative" data-column="high">High</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable relative" data-column="low">Low</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable relative" data-column="close">Close</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable relative" data-column="volume">Volume</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable relative" data-column="fiftyTwoWeekHigh">52W High</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable relative" data-column="fiftyTwoWeekLow">52W Low</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable relative" data-column="trend">Trend</th>
                                </tr>
                            </thead>
                            <tbody id="stock-tbody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-6 mb-8">
                        <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-6 rounded-xl border border-indigo-200 text-center flex flex-col justify-end">
                            <h3 class="text-sm font-medium text-indigo-600 uppercase tracking-wide mb-2">Total Tickers</h3>
                            <div class="text-3xl font-bold text-indigo-800" id="total-tickers">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-6 rounded-xl border border-emerald-200 text-center flex flex-col justify-end">
                            <h3 class="text-sm font-medium text-emerald-600 uppercase tracking-wide mb-2">Up Today</h3>
                            <div class="text-3xl font-bold text-emerald-800" id="up-count">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-rose-50 to-rose-100 p-6 rounded-xl border border-rose-200 text-center flex flex-col justify-end">
                            <h3 class="text-sm font-medium text-rose-600 uppercase tracking-wide mb-2">Down Today</h3>
                            <div class="text-3xl font-bold text-rose-800" id="down-count">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Controls Section - 3 Cards in One Row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl theme-shadow flex flex-col">
                    <h3 class="text-xl font-bold theme-text-primary mb-6">Dashboard Controls</h3>
                    
                    <div class="mt-auto">
                        <button class="w-full theme-button-primary text-white font-medium py-3 px-4 rounded-lg shadow-lg" onclick="refreshData()">
                            Refresh Data
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl theme-shadow flex flex-col">
                    <h4 class="text-lg font-semibold theme-text-primary mb-4">Manage Tickers</h4>
                    <input type="text" id="new-ticker" placeholder="e.g., AAPL" maxlength="10" class="w-full px-4 py-3 theme-border border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-3">
                    
                    <div class="mt-auto">
                        <button onclick="addTicker()" class="w-full theme-button-success text-white font-medium py-3 px-4 rounded-lg">Add to Watchlist</button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl theme-shadow flex flex-col">
                    <h4 class="text-lg font-semibold theme-text-primary mb-4">Remove Ticker</h4>
                    <select id="ticker-select" class="w-full px-4 py-3 theme-border border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-3">
                        <option value="">Select ticker to remove...</option>
                    </select>
                    
                    <div class="mt-auto">
                        <button onclick="removeTicker()" class="w-full theme-button-danger text-white font-medium py-3 px-4 rounded-lg">Remove from Watchlist</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Ratios and Index Charts Section -->
        <div class="px-8 pb-8 space-y-8">
            <!-- IWM / QQQ Risk Appetite Chart -->
            <div class="bg-white rounded-xl theme-shadow overflow-hidden">
                <div class="p-6 border-b theme-border">
                    <h2 class="text-2xl font-bold theme-text-primary mb-2">IWM / QQQ Risk Appetite</h2>
                    <p class="theme-text-secondary">Small caps ÷ Big tech - Risk appetite (speculative mood)</p>
                </div>
                
                <!-- Tab Navigation -->
                <div class="border-b theme-border">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button class="tab-button active py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600" data-metric="iwm-qqq" data-period="1y">
                            1-Year
                        </button>
                        <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-metric="iwm-qqq" data-period="3mo">
                            3-Month
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <div class="tab-content" id="tab-iwm-qqq-1y">
                        <div class="mb-6">
                            <canvas id="chart-iwm-qqq-1y" width="800" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div class="tab-content hidden" id="tab-iwm-qqq-3mo">
                        <div class="mb-6">
                            <canvas id="chart-iwm-qqq-3mo" width="800" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Statistics Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Current Ratio</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-iwm-qqq-current">-</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Daily Change</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-iwm-qqq-change">-</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Sentiment</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-iwm-qqq-sentiment">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RSP / SPY Market Breadth Chart -->
            <div class="bg-white rounded-xl theme-shadow overflow-hidden">
                <div class="p-6 border-b theme-border">
                    <h2 class="text-2xl font-bold theme-text-primary mb-2">RSP / SPY Market Breadth</h2>
                    <p class="theme-text-secondary">Equal-weight S&P ÷ Cap-weighted S&P - Market breadth (how broad the rally is)</p>
                </div>
                
                <!-- Tab Navigation -->
                <div class="border-b theme-border">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button class="tab-button active py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600" data-metric="rsp-spy" data-period="1y">
                            1-Year
                        </button>
                        <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-metric="rsp-spy" data-period="3mo">
                            3-Month
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <div class="tab-content" id="tab-rsp-spy-1y">
                        <div class="mb-6">
                            <canvas id="chart-rsp-spy-1y" width="800" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div class="tab-content hidden" id="tab-rsp-spy-3mo">
                        <div class="mb-6">
                            <canvas id="chart-rsp-spy-3mo" width="800" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Statistics Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Current Ratio</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-rsp-spy-current">-</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Daily Change</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-rsp-spy-change">-</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Breadth</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-rsp-spy-sentiment">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- XLI / XLU Economic Confidence Chart -->
            <div class="bg-white rounded-xl theme-shadow overflow-hidden">
                <div class="p-6 border-b theme-border">
                    <h2 class="text-2xl font-bold theme-text-primary mb-2">XLI / XLU Economic Confidence</h2>
                    <p class="theme-text-secondary">Industrials ÷ Utilities - Economic confidence (growth vs defense)</p>
                </div>
                
                <!-- Tab Navigation -->
                <div class="border-b theme-border">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button class="tab-button active py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600" data-metric="xli-xlu" data-period="1y">
                            1-Year
                        </button>
                        <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-metric="xli-xlu" data-period="3mo">
                            3-Month
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <div class="tab-content" id="tab-xli-xlu-1y">
                        <div class="mb-6">
                            <canvas id="chart-xli-xlu-1y" width="800" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div class="tab-content hidden" id="tab-xli-xlu-3mo">
                        <div class="mb-6">
                            <canvas id="chart-xli-xlu-3mo" width="800" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Statistics Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Current Ratio</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-xli-xlu-current">-</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Daily Change</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-xli-xlu-change">-</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Confidence</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-xli-xlu-sentiment">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- XLF / XLK Value vs Growth Chart -->
            <div class="bg-white rounded-xl theme-shadow overflow-hidden">
                <div class="p-6 border-b theme-border">
                    <h2 class="text-2xl font-bold theme-text-primary mb-2">XLF / XLK Value vs Growth</h2>
                    <p class="theme-text-secondary">Financials ÷ Technology - Value vs growth rotation</p>
                </div>
                
                <!-- Tab Navigation -->
                <div class="border-b theme-border">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button class="tab-button active py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600" data-metric="xlf-xlk" data-period="1y">
                            1-Year
                        </button>
                        <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-metric="xlf-xlk" data-period="3mo">
                            3-Month
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <div class="tab-content" id="tab-xlf-xlk-1y">
                        <div class="mb-6">
                            <canvas id="chart-xlf-xlk-1y" width="800" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div class="tab-content hidden" id="tab-xlf-xlk-3mo">
                        <div class="mb-6">
                            <canvas id="chart-xlf-xlk-3mo" width="800" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Statistics Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Current Ratio</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-xlf-xlk-current">-</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Daily Change</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-xlf-xlk-change">-</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Rotation</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-xlf-xlk-sentiment">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HYG / IEF Credit Risk Chart -->
            <div class="bg-white rounded-xl theme-shadow overflow-hidden">
                <div class="p-6 border-b theme-border">
                    <h2 class="text-2xl font-bold theme-text-primary mb-2">HYG / IEF Credit Risk</h2>
                    <p class="theme-text-secondary">High-yield bonds ÷ Treasuries - Credit risk appetite (risk tolerance in bond market)</p>
                </div>
                
                <!-- Tab Navigation -->
                <div class="border-b theme-border">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button class="tab-button active py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600" data-metric="hyg-ief" data-period="1y">
                            1-Year
                        </button>
                        <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-metric="hyg-ief" data-period="3mo">
                            3-Month
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <div class="tab-content" id="tab-hyg-ief-1y">
                        <div class="mb-6">
                            <canvas id="chart-hyg-ief-1y" width="800" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div class="tab-content hidden" id="tab-hyg-ief-3mo">
                        <div class="mb-6">
                            <canvas id="chart-hyg-ief-3mo" width="800" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Statistics Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Current Ratio</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-hyg-ief-current">-</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Daily Change</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-hyg-ief-change">-</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Risk Appetite</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-hyg-ief-sentiment">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIX Volatility Index Chart -->
            <div class="bg-white rounded-xl theme-shadow overflow-hidden">
                <div class="p-6 border-b theme-border">
                    <h2 class="text-2xl font-bold theme-text-primary mb-2">VIX Volatility Index</h2>
                    <p class="theme-text-secondary">Volatility index (CBOE) - Fear or calm level in the market</p>
                </div>
                
                <!-- Tab Navigation -->
                <div class="border-b theme-border">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button class="tab-button active py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600" data-metric="vix" data-period="1y">
                            1-Year
                        </button>
                        <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-metric="vix" data-period="3mo">
                            3-Month
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <div class="tab-content" id="tab-vix-1y">
                        <div class="mb-6">
                            <canvas id="chart-vix-1y" width="800" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div class="tab-content hidden" id="tab-vix-3mo">
                        <div class="mb-6">
                            <canvas id="chart-vix-3mo" width="800" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Statistics Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Current VIX</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-vix-current">-</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Daily Change</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-vix-change">-</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg theme-border border text-center">
                            <h4 class="text-sm font-medium theme-text-secondary mb-2">Market Mood</h4>
                            <div class="text-xl font-bold theme-text-primary" id="stats-vix-sentiment">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-slate-800 text-white p-6 text-center">
            <p class="text-slate-200"><strong>Author:</strong> Unknown | <strong>Version:</strong> 1.0 MVP | <strong>License:</strong> MIT</p>
            <p class="text-slate-300 text-sm mt-1">Built with HTML, Tailwind CSS, JavaScript and Yahoo Finance API</p>
        </div>
    </div>

    <script>
        // Default watchlist
        let watchlist = ["AAPL", "NVDA", "TSLA", "META", "AMZN", "GOOG", "MSFT"];
        
        // Chart storage for 6 metrics with 2 periods each
        let ratioCharts = {
            'iwm-qqq': { '1y': null, '3mo': null },
            'rsp-spy': { '1y': null, '3mo': null },
            'xli-xlu': { '1y': null, '3mo': null },
            'xlf-xlk': { '1y': null, '3mo': null },
            'hyg-ief': { '1y': null, '3mo': null },
            'vix': { '1y': null, '3mo': null }
        };
        
        // Metric configurations
        const metrics = {
            'iwm-qqq': { 
                name: 'IWM / QQQ Risk Appetite', 
                tickers: ['IWM', 'QQQ'], 
                isRatio: true,
                colors: { border: 'orange', background: 'rgba(255, 165, 0, 0.1)' }
            },
            'rsp-spy': { 
                name: 'RSP / SPY Market Breadth', 
                tickers: ['RSP', 'SPY'], 
                isRatio: true,
                colors: { border: 'blue', background: 'rgba(0, 123, 255, 0.1)' }
            },
            'xli-xlu': { 
                name: 'XLI / XLU Economic Confidence', 
                tickers: ['XLI', 'XLU'], 
                isRatio: true,
                colors: { border: 'green', background: 'rgba(0, 200, 83, 0.1)' }
            },
            'xlf-xlk': { 
                name: 'XLF / XLK Value vs Growth', 
                tickers: ['XLF', 'XLK'], 
                isRatio: true,
                colors: { border: 'purple', background: 'rgba(156, 39, 176, 0.1)' }
            },
            'hyg-ief': { 
                name: 'HYG / IEF Credit Risk', 
                tickers: ['HYG', 'IEF'], 
                isRatio: true,
                colors: { border: 'red', background: 'rgba(244, 67, 54, 0.1)' }
            },
            'vix': { 
                name: 'VIX Volatility Index', 
                tickers: ['^VIX'], 
                isRatio: false,
                colors: { border: 'darkred', background: 'rgba(139, 0, 0, 0.1)' }
            }
        };
        
        let currentStockData = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadWatchlistData();
            loadAllRatioCharts();
            
            // Add click event listeners to table headers for sorting
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', handleColumnSort);
            });
            
            // Add tab event listeners
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', handleTabClick);
            });
        });

        // Load watchlist data with improved error handling
        async function loadWatchlistData() {
            const loading = document.getElementById('loading');
            const content = document.getElementById('watchlist-content');
            
            loading.classList.remove('hidden');
            loading.classList.add('block');
            content.classList.add('hidden');
            content.classList.remove('block');

            try {
                console.log(`Loading watchlist data for ${watchlist.length} tickers...`);
                const stockData = [];
                let loadedCount = 0;
                let failedCount = 0;
                
                // Load stocks in parallel for better performance
                const stockPromises = watchlist.map(async (ticker) => {
                    try {
                        const data = await getStockSummary(ticker);
                        if (data) {
                            stockData.push(data);
                            loadedCount++;
                            console.log(`Loaded ${ticker} (${loadedCount}/${watchlist.length})`);
                        } else {
                            failedCount++;
                            console.warn(`Failed to load ${ticker} (${failedCount} failures)`);
                        }
                    } catch (error) {
                        failedCount++;
                        console.error(`Error fetching data for ${ticker}:`, error);
                    }
                });
                
                // Wait for all stock data to load
                await Promise.allSettled(stockPromises);
                
                console.log(`Watchlist loading complete: ${loadedCount} loaded, ${failedCount} failed`);
                
                // Update loading message if there were failures
                if (failedCount > 0) {
                    const loadingElement = document.getElementById('loading');
                    loadingElement.innerHTML = `
                        <div class="text-center py-10">
                            <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
                            <p class="text-gray-600">Loading complete: ${loadedCount} stocks loaded, ${failedCount} failed</p>
                        </div>
                    `;
                    
                    // Show the content after a brief delay
                    setTimeout(() => {
                        displayStockData(stockData);
                        loading.classList.add('hidden');
                        loading.classList.remove('block');
                        content.classList.remove('hidden');
                        content.classList.add('block');
                    }, 1000);
                } else {
                    displayStockData(stockData);
                    loading.classList.add('hidden');
                    loading.classList.remove('block');
                    content.classList.remove('hidden');
                    content.classList.add('block');
                }
                
            } catch (error) {
                console.error('Error loading watchlist data:', error);
                loading.innerHTML = `
                    <div class="bg-rose-50 border border-rose-200 text-rose-700 px-4 py-3 rounded-lg">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <div>
                                <strong>Failed to load stock data</strong><br>
                                Please check your internet connection and try refreshing the page.
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Generic retry function with exponential backoff
        async function fetchWithRetry(url, options = {}, maxRetries = 2, baseDelay = 2000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        mode: 'cors',
                        credentials: 'omit',
                        timeout: 10000 // 10 second timeout
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    return data;
                    
                } catch (error) {
                    console.warn(`Attempt ${attempt}/${maxRetries} failed for ${url}:`, error.message);
                    
                    if (attempt === maxRetries) {
                        console.error(`All ${maxRetries} attempts failed for ${url}`);
                        throw error;
                    }
                    
                    // Exponential backoff: 1s, 2s, 4s
                    const delay = baseDelay * Math.pow(2, attempt - 1);
                    console.log(`Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // Get stock summary data with retry mechanism
        async function getStockSummary(ticker) {
            try {
                // Using multiple CORS proxy options for better reliability
                const proxies = [
                    'https://cors-anywhere.herokuapp.com/',
                    'https://thingproxy.freeboard.io/fetch/',
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?'
                ];
                
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}`;
                
                let data = null;
                for (let i = 0; i < proxies.length; i++) {
                    const proxy = proxies[i];
                    try {
                        const url = proxy === 'https://api.allorigins.win/raw?url=' 
                            ? proxy + encodeURIComponent(yahooUrl)
                            : proxy === 'https://corsproxy.io/?'
                            ? proxy + encodeURIComponent(yahooUrl)
                            : proxy + yahooUrl;
                        data = await fetchWithRetry(url);
                        if (data && data.chart) break;
                    } catch (error) {
                        console.warn(`Proxy ${proxy} failed, trying next...`);
                        // Add delay between proxy attempts to avoid rate limiting
                        if (i < proxies.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                        continue;
                    }
                }
                
                if (!data) {
                    throw new Error('All proxies failed');
                }
                
                if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
                    console.warn(`No chart data available for ${ticker}`);
                    return null;
                }

                const result = data.chart.result[0];
                const meta = result.meta;
                const quotes = result.indicators.quote[0];
                
                // Extract all available fields from Yahoo Finance API
                const currentPrice = meta.regularMarketPrice;
                const previousClose = meta.previousClose;
                const change = ((currentPrice - previousClose) / previousClose) * 100;
                const changeAmount = currentPrice - previousClose;
                const volume = meta.regularMarketVolume;
                const trend = currentPrice > previousClose ? 'up' : 'down';
                
                // Additional fields available from the API - try multiple sources
                const open = meta.regularMarketOpen || meta.open || (quotes && quotes.open && quotes.open[quotes.open.length - 1]);
                const high = meta.regularMarketDayHigh || meta.dayHigh || (quotes && quotes.high && quotes.high[quotes.high.length - 1]);
                const low = meta.regularMarketDayLow || meta.dayLow || (quotes && quotes.low && quotes.low[quotes.low.length - 1]);
                const close = meta.previousClose;
                const fiftyTwoWeekHigh = meta.fiftyTwoWeekHigh;
                const fiftyTwoWeekLow = meta.fiftyTwoWeekLow;
                const eps = meta.trailingAnnualDividendRate;
                const currency = meta.currency;
                const timezone = meta.exchangeTimezoneName;
                const lastUpdate = new Date(meta.regularMarketTime * 1000);
                
                console.log(`Successfully fetched data for ${ticker}`);

                return {
                    ticker: ticker,
                    price: currentPrice ? currentPrice.toFixed(2) : 'N/A',
                    change: change ? change.toFixed(2) : 'N/A',
                    changeAmount: changeAmount ? changeAmount.toFixed(2) : 'N/A',
                    volume: volume ? volume.toLocaleString() : 'N/A',
                    trend: trend,
                    open: (open && open !== 0) ? open.toFixed(2) : 'N/A',
                    high: (high && high !== 0) ? high.toFixed(2) : 'N/A',
                    low: (low && low !== 0) ? low.toFixed(2) : 'N/A',
                    close: (close && close !== 0) ? close.toFixed(2) : 'N/A',
                    fiftyTwoWeekHigh: (fiftyTwoWeekHigh && fiftyTwoWeekHigh !== 0) ? fiftyTwoWeekHigh.toFixed(2) : 'N/A',
                    fiftyTwoWeekLow: (fiftyTwoWeekLow && fiftyTwoWeekLow !== 0) ? fiftyTwoWeekLow.toFixed(2) : 'N/A',
                    eps: (eps && eps !== 0) ? eps.toFixed(2) : 'N/A',
                    currency: currency || 'USD',
                    timezone: timezone || 'N/A',
                    lastUpdate: lastUpdate.toLocaleTimeString()
                };
                
            } catch (error) {
                console.error(`Failed to fetch data for ${ticker} after all retries:`, error);
                return null;
            }
        }


        // Display stock data in table
        function displayStockData(data) {
            // Store the data for sorting
            currentStockData = data;
            
            const tbody = document.getElementById('stock-tbody');
            tbody.innerHTML = '';

            data.forEach(stock => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-150';
                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="text-sm font-bold text-gray-900">${stock.ticker}</div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">$${stock.price}</div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="text-sm font-bold ${parseFloat(stock.change) >= 0 ? 'text-emerald-600' : 'text-rose-600'}">
                            ${parseFloat(stock.change) >= 0 ? '+' : ''}${stock.change}%
                        </div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="text-sm font-bold ${parseFloat(stock.changeAmount) >= 0 ? 'text-emerald-600' : 'text-rose-600'}">
                            ${parseFloat(stock.changeAmount) >= 0 ? '+' : ''}$${stock.changeAmount}
                        </div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">$${stock.open}</div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">$${stock.high}</div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">$${stock.low}</div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">$${stock.close}</div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${stock.volume}</div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">$${stock.fiftyTwoWeekHigh}</div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">$${stock.fiftyTwoWeekLow}</div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${stock.trend === 'up' ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800'}">
                            ${stock.trend.toUpperCase()}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Update statistics
            const totalTickers = data.length;
            const upCount = data.filter(stock => stock.trend === 'up').length;
            const downCount = data.filter(stock => stock.trend === 'down').length;

            document.getElementById('total-tickers').textContent = totalTickers;
            document.getElementById('up-count').textContent = upCount;
            document.getElementById('down-count').textContent = downCount;

            // Update ticker select dropdown
            updateTickerSelect();
        }

        // Sort stock data
        function sortStockData(column, direction) {
            if (!currentStockData || currentStockData.length === 0) return;

            const sortedData = [...currentStockData].sort((a, b) => {
                let aVal, bVal;

                switch (column) {
                    case 'ticker':
                        aVal = a.ticker.toLowerCase();
                        bVal = b.ticker.toLowerCase();
                        break;
                    case 'price':
                        aVal = parseFloat(a.price) || 0;
                        bVal = parseFloat(b.price) || 0;
                        break;
                    case 'change':
                        aVal = parseFloat(a.change) || 0;
                        bVal = parseFloat(b.change) || 0;
                        break;
                    case 'changeAmount':
                        aVal = parseFloat(a.changeAmount) || 0;
                        bVal = parseFloat(b.changeAmount) || 0;
                        break;
                    case 'open':
                        aVal = parseFloat(a.open) || 0;
                        bVal = parseFloat(b.open) || 0;
                        break;
                    case 'high':
                        aVal = parseFloat(a.high) || 0;
                        bVal = parseFloat(b.high) || 0;
                        break;
                    case 'low':
                        aVal = parseFloat(a.low) || 0;
                        bVal = parseFloat(b.low) || 0;
                        break;
                    case 'volume':
                        // Remove commas and convert to number
                        aVal = parseInt(a.volume.replace(/,/g, '')) || 0;
                        bVal = parseInt(b.volume.replace(/,/g, '')) || 0;
                        break;
                    case 'close':
                        aVal = parseFloat(a.close) || 0;
                        bVal = parseFloat(b.close) || 0;
                        break;
                    case 'fiftyTwoWeekHigh':
                        aVal = parseFloat(a.fiftyTwoWeekHigh) || 0;
                        bVal = parseFloat(b.fiftyTwoWeekHigh) || 0;
                        break;
                    case 'fiftyTwoWeekLow':
                        aVal = parseFloat(a.fiftyTwoWeekLow) || 0;
                        bVal = parseFloat(b.fiftyTwoWeekLow) || 0;
                        break;
                    case 'trend':
                        aVal = a.trend === 'up' ? 1 : 0;
                        bVal = b.trend === 'up' ? 1 : 0;
                        break;
                    default:
                        return 0;
                }

                if (direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });

            displayStockData(sortedData);
        }

        // Handle column header click for sorting
        function handleColumnSort(event) {
            const column = event.target.getAttribute('data-column');
            if (!column) return;

            // Determine sort direction
            let direction = 'asc';
            if (currentSortColumn === column && currentSortDirection === 'asc') {
                direction = 'desc';
            }

            // Update sort state
            currentSortColumn = column;
            currentSortDirection = direction;

            // Update header classes
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            event.target.classList.add(`sort-${direction}`);

            // Sort the data
            sortStockData(column, direction);
        }

        // Load all ratio/index charts with improved error handling
        async function loadAllRatioCharts() {
            const periods = ['1y', '3mo'];
            const totalCharts = Object.keys(metrics).length * periods.length;
            let loadedCharts = 0;
            let failedCharts = 0;
            
            console.log(`Starting to load ${totalCharts} charts...`);
            
            // Load charts in parallel for better performance
            const chartPromises = [];
            
            for (const metricKey of Object.keys(metrics)) {
                const metric = metrics[metricKey];
                
                for (const period of periods) {
                    const chartPromise = loadSingleChart(metricKey, metric, period)
                        .then(() => {
                            loadedCharts++;
                            console.log(`Chart loaded: ${metricKey} ${period} (${loadedCharts}/${totalCharts})`);
                        })
                        .catch((error) => {
                            failedCharts++;
                            console.error(`Chart failed: ${metricKey} ${period} (${failedCharts} failures)`, error);
                        });
                    
                    chartPromises.push(chartPromise);
                }
            }
            
            // Wait for all charts to complete (success or failure)
            await Promise.allSettled(chartPromises);
            
            console.log(`Chart loading complete: ${loadedCharts} loaded, ${failedCharts} failed`);
            
            // Update statistics for all metrics after all charts are loaded
            setTimeout(() => {
                updateAllStatistics();
            }, 1000);
        }

        // Load a single chart with retry logic
        async function loadSingleChart(metricKey, metric, period) {
            const maxRetries = 2; // Additional retries for chart loading
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    if (metric.isRatio) {
                        // Handle ratio calculations
                        const [data1, data2] = await Promise.all([
                            getHistoricalData(metric.tickers[0], period),
                            getHistoricalData(metric.tickers[1], period)
                        ]);

                        if (!data1 || !data2) {
                            throw new Error(`Failed to fetch historical data for ${metricKey} ${period}`);
                        }

                        // Calculate ratio
                        const ratio = calculateRatio(data1, data2);
                        
                        if (ratio.length === 0) {
                            throw new Error(`Insufficient data for ratio calculation for ${metricKey} ${period}`);
                        }

                        // Create chart
                        createRatioChart(ratio, metricKey, period, metric);
                        
                    } else {
                        // Handle direct values (like VIX)
                        const data = await getHistoricalData(metric.tickers[0], period);
                        
                        if (!data) {
                            throw new Error(`Failed to fetch historical data for ${metricKey} ${period}`);
                        }

                        // Convert to chart format
                        const chartData = data.closes.map((value, index) => ({
                            date: new Date(data.timestamps[index] * 1000),
                            value: value
                        }));

                        // Create chart
                        createRatioChart(chartData, metricKey, period, metric);
                    }
                    
                    return; // Success, exit retry loop
                    
                } catch (error) {
                    console.warn(`Attempt ${attempt}/${maxRetries} failed for ${metricKey} ${period}:`, error.message);
                    
                    if (attempt === maxRetries) {
                        // Show error message in the chart area
                        const tabContent = document.getElementById(`tab-${metricKey}-${period}`);
                        if (tabContent) {
                            tabContent.innerHTML = `
                                <div class="bg-amber-50 border border-amber-200 text-amber-700 px-4 py-3 rounded-lg">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                        </svg>
                                        <div>
                                            <strong>Chart Loading Failed</strong><br>
                                            ${metric.name} (${period})<br>
                                            <small>Please try refreshing the page</small>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        throw error;
                    }
                    
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, 2000 * attempt));
                }
            }
        }

        // Handle tab clicks
        function handleTabClick(event) {
            const metric = event.target.getAttribute('data-metric');
            const period = event.target.getAttribute('data-period');
            if (!metric || !period) return;

            // Update tab button styles for this metric
            const metricButtons = document.querySelectorAll(`[data-metric="${metric}"]`);
            metricButtons.forEach(button => {
                button.classList.remove('active', 'border-indigo-500', 'text-indigo-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });

            event.target.classList.add('active', 'border-indigo-500', 'text-indigo-600');
            event.target.classList.remove('border-transparent', 'text-gray-500');

            // Show/hide tab content for this metric
            const metricTabs = document.querySelectorAll(`[id^="tab-${metric}-"]`);
            metricTabs.forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(`tab-${metric}-${period}`).classList.remove('hidden');

            // Update statistics if chart exists
            if (ratioCharts[metric] && ratioCharts[metric][period]) {
                const chart = ratioCharts[metric][period];
                if (chart && chart.data && chart.data.datasets[0].data.length > 0) {
                    const data = chart.data.datasets[0].data.map((value, index) => ({
                        value: value,
                        date: new Date(chart.data.labels[index])
                    }));
                    updateRatioStats(data, metric);
                }
            }
        }

        // Get historical data with retry mechanism
        async function getHistoricalData(ticker, period) {
            try {
                // Using multiple CORS proxy options for better reliability
                const proxies = [
                    'https://cors-anywhere.herokuapp.com/',
                    'https://thingproxy.freeboard.io/fetch/',
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?'
                ];
                
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=${period}&interval=1d`;
                
                let data = null;
                for (let i = 0; i < proxies.length; i++) {
                    const proxy = proxies[i];
                    try {
                        const url = proxy === 'https://api.allorigins.win/raw?url=' 
                            ? proxy + encodeURIComponent(yahooUrl)
                            : proxy === 'https://corsproxy.io/?'
                            ? proxy + encodeURIComponent(yahooUrl)
                            : proxy + yahooUrl;
                        data = await fetchWithRetry(url);
                        if (data && data.chart) break;
                    } catch (error) {
                        console.warn(`Proxy ${proxy} failed, trying next...`);
                        // Add delay between proxy attempts to avoid rate limiting
                        if (i < proxies.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                        continue;
                    }
                }
                
                if (!data) {
                    throw new Error('All proxies failed');
                }
                
                if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
                    console.warn(`No historical data available for ${ticker} (${period})`);
                    return null;
                }

                const result = data.chart.result[0];
                const timestamps = result.timestamp;
                const quotes = result.indicators.quote[0];
                
                if (!timestamps || !quotes || !quotes.close) {
                    console.warn(`Incomplete historical data for ${ticker} (${period})`);
                    return null;
                }
                
                console.log(`Successfully fetched historical data for ${ticker} (${period}): ${timestamps.length} data points`);
                
                return {
                    timestamps: timestamps,
                    closes: quotes.close
                };
                
            } catch (error) {
                console.error(`Failed to fetch historical data for ${ticker} (${period}) after all retries:`, error);
                return null;
            }
        }

        // Calculate IWM/QQQ ratio
        function calculateRatio(iwmData, qqqData) {
            const ratio = [];
            const iwmCloses = iwmData.closes;
            const qqqCloses = qqqData.closes;
            const timestamps = iwmData.timestamps;

            for (let i = 0; i < Math.min(iwmCloses.length, qqqCloses.length); i++) {
                if (iwmCloses[i] && qqqCloses[i]) {
                    ratio.push({
                        date: new Date(timestamps[i] * 1000),
                        ratio: iwmCloses[i] / qqqCloses[i]
                    });
                }
            }

            return ratio;
        }

        // Create ratio chart
        function createRatioChart(data, metricKey, period, metric) {
            const canvasId = `chart-${metricKey}-${period}`;
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (ratioCharts[metricKey] && ratioCharts[metricKey][period]) {
                ratioCharts[metricKey][period].destroy();
            }

            const periodLabels = {
                '1y': '1-Year',
                '3mo': '3-Month'
            };

            // Determine data values and labels
            const values = data.map(d => d.value || d.ratio);
            const labels = data.map(d => d.date.toLocaleDateString());

            ratioCharts[metricKey][period] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: metric.name,
                        data: values,
                        borderColor: metric.colors.border,
                        backgroundColor: metric.colors.background,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${periodLabels[period]} ${metric.name}`,
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: metric.isRatio ? 'Ratio' : 'Value'
                            }
                        }
                    }
                }
            });

            // Update statistics after chart creation
            updateRatioStats(data, metricKey);
        }

        // Update ratio statistics
        function updateRatioStats(data, metricKey) {
            if (!data || data.length < 2) {
                console.warn(`Insufficient data for ${metricKey} statistics`);
                return;
            }

            try {
                const currentValue = data[data.length - 1].value || data[data.length - 1].ratio;
                const previousValue = data[data.length - 2].value || data[data.length - 2].ratio;
                
                if (!currentValue || !previousValue || previousValue === 0) {
                    console.warn(`Invalid data values for ${metricKey}: current=${currentValue}, previous=${previousValue}`);
                    return;
                }

                const dailyChange = ((currentValue - previousValue) / previousValue) * 100;
                
                // Update the specific metric's statistics
                const currentElement = document.getElementById(`stats-${metricKey}-current`);
                const changeElement = document.getElementById(`stats-${metricKey}-change`);
                const sentimentElement = document.getElementById(`stats-${metricKey}-sentiment`);
                
                if (currentElement) {
                    currentElement.textContent = currentValue.toFixed(4);
                }
                
                if (changeElement) {
                    changeElement.textContent = `${dailyChange.toFixed(2)}%`;
                }
                
                // Set sentiment based on metric type
                let sentiment = '';
                if (metricKey === 'vix') {
                    sentiment = currentValue > 20 ? 'Fear' : 'Calm';
                } else if (metricKey === 'iwm-qqq') {
                    sentiment = dailyChange > 0 ? 'Risk-On' : 'Risk-Off';
                } else if (metricKey === 'rsp-spy') {
                    sentiment = dailyChange > 0 ? 'Broad Rally' : 'Narrow Rally';
                } else if (metricKey === 'xli-xlu') {
                    sentiment = dailyChange > 0 ? 'Growth' : 'Defense';
                } else if (metricKey === 'xlf-xlk') {
                    sentiment = dailyChange > 0 ? 'Value' : 'Growth';
                } else if (metricKey === 'hyg-ief') {
                    sentiment = dailyChange > 0 ? 'Risk-On' : 'Risk-Off';
                }
                
                if (sentimentElement) {
                    sentimentElement.textContent = sentiment;
                }
                
                console.log(`Updated statistics for ${metricKey}:`, {
                    current: currentValue.toFixed(4),
                    change: `${dailyChange.toFixed(2)}%`,
                    sentiment: sentiment
                });
                
            } catch (error) {
                console.error(`Error updating statistics for ${metricKey}:`, error);
            }
        }

        // Update all statistics for all metrics
        function updateAllStatistics() {
            console.log('Updating all statistics...');
            
            for (const metricKey of Object.keys(metrics)) {
                // Try to get data from the 1-year chart first, then 3-month
                let chartData = null;
                let period = '1y';
                
                if (ratioCharts[metricKey] && ratioCharts[metricKey]['1y'] && ratioCharts[metricKey]['1y'].data) {
                    const chart = ratioCharts[metricKey]['1y'];
                    chartData = chart.data.datasets[0].data.map((value, index) => ({
                        value: value,
                        date: new Date(chart.data.labels[index])
                    }));
                } else if (ratioCharts[metricKey] && ratioCharts[metricKey]['3mo'] && ratioCharts[metricKey]['3mo'].data) {
                    const chart = ratioCharts[metricKey]['3mo'];
                    chartData = chart.data.datasets[0].data.map((value, index) => ({
                        value: value,
                        date: new Date(chart.data.labels[index])
                    }));
                    period = '3mo';
                }
                
                if (chartData && chartData.length > 0) {
                    console.log(`Updating statistics for ${metricKey} using ${period} data`);
                    updateRatioStats(chartData, metricKey);
                } else {
                    console.warn(`No chart data available for ${metricKey}`);
                }
            }
        }

        // Add new ticker to watchlist
        function addTicker() {
            const input = document.getElementById('new-ticker');
            const ticker = input.value.trim().toUpperCase();
            
            if (!ticker) {
                showMessage('Please enter a ticker symbol', 'warning');
                return;
            }

            if (watchlist.includes(ticker)) {
                showMessage(`${ticker} is already in watchlist`, 'warning');
                return;
            }

            watchlist.push(ticker);
            input.value = '';
            showMessage(`Added ${ticker} to watchlist`, 'success');
            loadWatchlistData();
        }

        // Remove ticker from watchlist using dropdown
        function removeTicker() {
            const select = document.getElementById('ticker-select');
            const ticker = select.value;
            
            if (!ticker) {
                showMessage('Please select a ticker to remove', 'warning');
                return;
            }

            if (confirm(`Are you sure you want to remove ${ticker} from your watchlist?`)) {
                const index = watchlist.indexOf(ticker);
                if (index > -1) {
                    watchlist.splice(index, 1);
                    showMessage(`Removed ${ticker} from watchlist`, 'success');
                    loadWatchlistData();
                }
            }
        }


        // Update ticker select dropdown
        function updateTickerSelect() {
            const select = document.getElementById('ticker-select');
            select.innerHTML = '<option value="">Select ticker to remove...</option>';
            
            // Sort tickers alphabetically
            const sortedTickers = [...watchlist].sort((a, b) => a.localeCompare(b));
            
            sortedTickers.forEach(ticker => {
                const option = document.createElement('option');
                option.value = ticker;
                option.textContent = ticker;
                select.appendChild(option);
            });
        }

        // Refresh all data with improved feedback
        async function refreshData() {
            const refreshButton = document.querySelector('button[onclick="refreshData()"]');
            const originalText = refreshButton.textContent;
            
            // Update button to show loading state
            refreshButton.disabled = true;
            refreshButton.textContent = 'Refreshing...';
            refreshButton.classList.add('opacity-50', 'cursor-not-allowed');
            
            try {
                console.log('Starting data refresh...');
                
                // Load data in parallel
                const [watchlistResult, chartsResult] = await Promise.allSettled([
                    loadWatchlistData(),
                    loadAllRatioCharts()
                ]);
                
                // Check results
                const watchlistSuccess = watchlistResult.status === 'fulfilled';
                const chartsSuccess = chartsResult.status === 'fulfilled';
                
                if (watchlistSuccess && chartsSuccess) {
                    showMessage('Data refreshed successfully', 'success');
                } else if (watchlistSuccess || chartsSuccess) {
                    showMessage('Data partially refreshed - some charts may have failed to load', 'warning');
                } else {
                    showMessage('Failed to refresh data - please try again', 'error');
                }
                
            } catch (error) {
                console.error('Error during refresh:', error);
                showMessage('Failed to refresh data - please try again', 'error');
            } finally {
                // Restore button state
                refreshButton.disabled = false;
                refreshButton.textContent = originalText;
                refreshButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Show message
        function showMessage(message, type) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            let bgColor, textColor, borderColor;
            
            switch(type) {
                case 'success':
                    bgColor = 'bg-emerald-50';
                    textColor = 'text-emerald-700';
                    borderColor = 'border-emerald-200';
                    break;
                case 'warning':
                    bgColor = 'bg-amber-50';
                    textColor = 'text-amber-700';
                    borderColor = 'border-amber-200';
                    break;
                case 'error':
                    bgColor = 'bg-rose-50';
                    textColor = 'text-rose-700';
                    borderColor = 'border-rose-200';
                    break;
                default:
                    bgColor = 'bg-indigo-50';
                    textColor = 'text-indigo-700';
                    borderColor = 'border-indigo-200';
            }
            
            messageDiv.className = `message ${bgColor} ${textColor} ${borderColor} border px-4 py-3 rounded-lg mb-4`;
            messageDiv.textContent = message;
            
            const controlsSection = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2');
            if (controlsSection) {
                controlsSection.insertBefore(messageDiv, controlsSection.firstChild);
            }
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Handle Enter key in ticker input
        document.getElementById('new-ticker').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTicker();
            }
        });
    </script>
</body>
</html>
